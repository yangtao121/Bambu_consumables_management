# GitLab CI: build & push x86 (amd64) images only (NO buildx, NO dind).
# Target registry: 192.168.5.54:5000 (currently no auth)
# Images:
# - 192.168.5.54:5000/bambu-consumables/api-x86:{tag}
# - 192.168.5.54:5000/bambu-consumables/collector-x86:{tag}
# - 192.168.5.54:5000/bambu-consumables/frontend-x86:{tag}
#
# Tag policy:
# - Git tag vX.Y.Z: push vX.Y.Z + latest
# - main branch: push latest + CI_COMMIT_SHORT_SHA
#
# Runner requirement:
# - GitLab Runner uses docker executor
# - privileged = true
# - mount: /var/run/docker.sock:/var/run/docker.sock (so docker CLI works inside job container)

stages:
  - build

variables:
  REGISTRY: "192.168.5.54:5000"
  IMAGE_NAMESPACE: "bambu-consumables"
  DOCKER_BUILDKIT: "1"

.build_and_push:
  stage: build
  image: docker:24.0.5
  services: []
  interruptible: true
  before_script:
    - docker info
  script:
    - |
      set -eu

      if [ -n "${CI_COMMIT_TAG:-}" ]; then
        TAGS="${CI_COMMIT_TAG} latest"
      elif [ "${CI_COMMIT_BRANCH:-}" = "main" ]; then
        TAGS="latest ${CI_COMMIT_SHORT_SHA}"
      else
        echo "Skip: not main and not a semver tag build"
        exit 0
      fi

      IMAGE="${REGISTRY}/${IMAGE_NAMESPACE}/${SERVICE_NAME}-x86"
      echo "Building ${IMAGE} for tags: ${TAGS}"

      BUILD_TAG_ARGS=""
      for t in ${TAGS}; do
        BUILD_TAG_ARGS="${BUILD_TAG_ARGS} -t ${IMAGE}:${t}"
      done

      # Build once with all tags.
      # shellcheck disable=SC2086
      docker build ${BUILD_TAG_ARGS} -f "${DOCKERFILE_PATH}" "${BUILD_CONTEXT}"

      for t in ${TAGS}; do
        docker push "${IMAGE}:${t}"
      done
  after_script:
    - |
      set -eu

      if [ -n "${CI_COMMIT_TAG:-}" ]; then
        TAGS="${CI_COMMIT_TAG} latest"
      elif [ "${CI_COMMIT_BRANCH:-}" = "main" ]; then
        TAGS="latest ${CI_COMMIT_SHORT_SHA}"
      else
        exit 0
      fi

      IMAGE="${REGISTRY}/${IMAGE_NAMESPACE}/${SERVICE_NAME}-x86"
      for t in ${TAGS}; do
        docker image rm "${IMAGE}:${t}" || true
      done
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
    - if: '$CI_COMMIT_BRANCH == "main"'

build_api_x86:
  extends: .build_and_push
  variables:
    SERVICE_NAME: "api"
    DOCKERFILE_PATH: "backend/Dockerfile"
    BUILD_CONTEXT: "backend"

build_collector_x86:
  extends: .build_and_push
  variables:
    SERVICE_NAME: "collector"
    DOCKERFILE_PATH: "collector/Dockerfile"
    BUILD_CONTEXT: "collector"

build_frontend_x86:
  extends: .build_and_push
  variables:
    SERVICE_NAME: "frontend"
    DOCKERFILE_PATH: "frontend/Dockerfile"
    BUILD_CONTEXT: "frontend"