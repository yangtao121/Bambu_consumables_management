## 备份与恢复（PostgreSQL）

本项目的核心数据在 PostgreSQL 中（compose 里对应 `db` 服务，数据落在 `db_data` 命名卷）。推荐 **逻辑备份**（`pg_dump`），跨版本与跨机器更稳。

> 建议：在每次升级前先做一次备份。

## 逻辑备份（推荐）

在部署目录执行：

```bash
BACKUP_FILE="backup_$(date +%F_%H%M%S).sql"
docker compose -f docker-compose.prod.yml exec -T db \
  pg_dump -U "${POSTGRES_USER:-consumables}" -d "${POSTGRES_DB:-consumables}" \
  > "${BACKUP_FILE}"
echo "backup saved to ${BACKUP_FILE}"
```

### 恢复（逻辑恢复）

恢复通常需要空库（或你确认覆盖）。最稳妥做法是新建一个空库再导入；这里给出“导入到当前库”的简单方式：

```bash
BACKUP_FILE="backup_xxx.sql"
docker compose -f docker-compose.prod.yml exec -T db \
  psql -U "${POSTGRES_USER:-consumables}" -d "${POSTGRES_DB:-consumables}" \
  < "${BACKUP_FILE}"
```

## 卷级备份（更快，但可移植性差）

适用于同版本/同环境快速整体搬迁。**需要停机**：

```bash
docker compose -f docker-compose.prod.yml down
```

导出 `db_data`（示例使用 alpine 打包）：

```bash
DB_VOL="$(docker volume ls -q | grep db_data | head -n 1)"
tar_file="db_data_$(date +%F_%H%M%S).tar.gz"

docker run --rm \
  -v "${DB_VOL}:/volume:ro" \
  -v "$(pwd):/backup" \
  alpine \
  sh -c "tar -czf /backup/${tar_file} -C /volume ."
echo "db volume backup saved to ${tar_file}"
```

恢复卷级备份（危险操作：会覆盖卷内容），建议在熟悉 Docker 卷的情况下再做。

