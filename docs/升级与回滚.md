## 升级与回滚（Docker Compose / 预编译镜像）

本文默认你使用 `docker-compose.prod.yml`，并通过 `.env` 中的 `IMAGE_TAG` 固定版本。

## 升级流程（推荐：固定版本 tag）

1) 修改 `.env`：

```bash
IMAGE_TAG=v1.1.0
```

2) 拉取新镜像并重建：

```bash
docker compose -f docker-compose.prod.yml pull
docker compose -f docker-compose.prod.yml up -d
```

3) 验证：

- `docker compose -f docker-compose.prod.yml ps`
- `curl -fsS "http://127.0.0.1:${API_PORT:-8000}/health"`
- 前端页面可访问，关键功能可用

说明：`api` 容器启动时会自动执行 `alembic upgrade head`（失败会重试），因此升级时不需要手工跑迁移。

## 回滚流程

1) 将 `.env` 里的 `IMAGE_TAG` 改回上一个稳定版本：

```bash
IMAGE_TAG=v1.0.0
```

2) 拉取并重建：

```bash
docker compose -f docker-compose.prod.yml pull
docker compose -f docker-compose.prod.yml up -d
```

3) 验证服务恢复正常。

## 关于 latest（不建议线上长期依赖）

`latest` 适合快速试用，但不利于排查与回滚。线上建议：

- 日常运行固定 `IMAGE_TAG=vX.Y.Z`
- 需要尝鲜时可临时改为 `latest`，验证后再落回具体版本

