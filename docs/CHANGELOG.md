# 更新日志

本文档记录了3D耗材管理系统的所有重要变更。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [未发布]

## [0.0.1] - 2025-12-20

### 新增
这是3D耗材管理系统的首个发布版本，专为拓竹打印机设计，通过局域网MQTT连接实现实时监控与耗材管理。

#### 打印机管理与实时监控
- 打印机接入管理：支持添加/删除打印机，保存IP/序列号/LAN访问码
- 实时状态监控：自动获取并显示打印机在线状态、打印进度、当前任务
- MQTT数据采集：通过局域网直连打印机，订阅设备报告并实时解析
- 托盘信息展示：显示当前使用托盘及所有AMS托盘状态（颜色、材质、剩余量）

#### 事件采集与处理
- MQTT连接管理：支持用户名`bblp`，密码为LAN Access Code，TLS 8883端口连接
- 原始事件存储：保存所有原始MQTT payload用于排错
- 事件标准化：从原始事件中提取关键字段并存储为标准化格式
- AMS托盘解析兼容：支持从不同固件路径抽取托盘信息

#### 打印作业管理
- PrintJob自动生成/更新：由后端事件处理器根据MQTT事件生成
- 作业去重策略：优先使用task_id/subtask_id，回退到时间+文件名组合
- 状态智能修正：当gcode_state=FINISH/IDLE时不会错误显示为running
- 打印进度跟踪：实时显示打印进度百分比和预计剩余时间

#### 耗材卷管理与托盘绑定
- 耗材卷信息录入：记录材质、颜色、初始重量、价格、供应商等详细信息
- 托盘绑定管理：支持将耗材卷绑定到打印机特定托盘，可随时解绑
- 库存状态跟踪：自动维护耗材卷状态（使用中、用完、报废等）
- 库存调整记录：支持手动盘点调整，保持库存数据准确性

#### 消耗记录与成本统计
- 自动消耗计算：打印结束时自动记录消耗，基于AMS剩余量差值计算
- 成本自动核算：根据耗材价格自动计算单次打印成本
- 消耗记录追溯：每条消耗记录关联具体打印任务和耗材卷
- 库存剩余重算：实时更新耗材卷的剩余克重估算值

#### 用户界面
- 响应式Web界面：基于Next.js构建的现代化用户界面
- 实时数据展示：使用SSE技术实现打印机状态的实时更新
- 多页面导航：包括打印机、作业、耗材卷、设置等多个功能页面
- 直观的数据可视化：通过图表和列表展示关键业务数据

### 已知限制
- 消耗克数并非实时计算，在PrintEnded/Failed后进行结算生成
- 当tray_now=255时（表示无有效托盘/虚拟托盘），可能无法可靠归因到具体耗材卷
- AMS的remain字段可能为-1或异常值，表示数据不可信或不可用
- 多色/换料分摊功能尚未实现，当前不支持按托盘分摊消耗
- 3MF/GCode元数据兜底策略尚未实现，当remain不可用时无备选方案


