# 更新日志

本文档记录了3D耗材管理系统的所有重要变更。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [0.0.3] - 2025-12-21

### 修复与增强
这是3D耗材管理系统的第三个版本，主要修复了时区处理问题，优化了库存管理性能，并增强了用户界面和调试工具集。

#### 数据库修复
- 修复消耗记录时区处理问题：确保所有消耗记录的created_at时间戳正确转换为时区感知的UTC
- 优化ConsumptionRecord模型：默认值设置为当前UTC时间，提高时间戳一致性
- 新增数据库迁移脚本：处理现有数据的时区转换，保证数据完整性

#### 库存管理优化
- 库存恢复功能：新增API端点和前端界面，支持恢复已归档的库存项，包括冲突处理机制
- 库存颜色映射查询优化：重构查询逻辑，使用子查询选择每种颜色的最新映射，提升查询性能
- 动态文本颜色调整：根据背景颜色亮度自动调整文本颜色，提升不同颜色背景下的可读性
- 库存页面布局改进：采用网格系统更好地组织库存项，提供更直观的用户体验

#### 调试工具增强
- 新增数据检查脚本：`check_recent_data.py`用于异步检查并报告最近的打印任务和消耗记录
- 耗材消耗诊断指南：`CONSUMPTION_DEBUGGING.md`提供全面的诊断指南，帮助排查重复消耗记录问题
- 多个测试脚本：验证新功能并确保事件处理和打印作业模拟期间的正确日志记录

#### 日志系统增强
- 事件处理日志：在事件处理的关键节点添加详细日志，便于问题排查
- 库存变更日志：详细记录每次库存变更的前后状态和原因
- 消耗记录创建日志：记录消耗记录创建过程的详细信息

### 已知限制
- 消耗克数并非实时计算，在PrintEnded/Failed后进行结算生成
- 当tray_now=255时（表示无有效托盘/虚拟托盘），可能无法可靠归因到具体耗材卷
- AMS的remain字段可能为-1或异常值，表示数据不可信或不可用
- 多色/换料分摊功能尚未实现，当前不支持按托盘分摊消耗
- 3MF/GCode元数据兜底策略尚未实现，当remain不可用时无备选方案

## [0.0.2] - 2025-12-21

### 新增
这是3D耗材管理系统的第二个版本，主要增强了报表功能、库存管理和颜色映射系统，提升了系统的完整性和易用性。

#### 数据模型增强
- 消耗记录支持无任务关联的手动库存消耗（job_id可为空）
- 添加消耗记录和材料账本的作废功能（voided_at, void_reason字段）
- 材料账本支持反向关联（reversal_of_id）实现可逆操作
- 增强审计追踪能力，支持数据回滚和纠错

#### 报表系统
- 新增完整的报表功能模块（/reports）
- 实现日报、月报和汇总报告API
- 支持按时间、材质、打印机等维度的消耗统计
- 成本计算使用移动加权平均算法，精确计算耗材成本
- 前端报表页面展示消耗克数和估算成本

#### 库存管理改进
- 库存页面增强UI，支持按颜色搜索和排序
- 添加颜色绑定功能，支持将库存项绑定到AMS颜色码
- 实现料盘丢弃功能和料盘计数统计
- 库存归档功能，保留历史数据但不在默认列表显示
- 库存页面显示颜色覆盖率和已消耗卷数统计

#### AMS颜色映射系统
- 实现AMS颜色码到颜色名称的映射管理
- 颜色映射一旦创建不可修改，保证数据一致性
- 支持幂等写入，避免重复创建
- 颜色映射设置页面，便于管理AMS颜色码与颜色名的对应关系

#### 调试工具集
- 新增材料调试工具页面（/settings/material-debug）
- 颜色码解析工具，查看映射和匹配的库存
- 库存查询工具，检查重复或错误的记录
- 当前颜色映射表查看功能

#### 用户界面优化
- 改进库存列表展示，增加更多统计信息
- 优化报表页面布局，提供更清晰的数据展示
- 增强颜色映射管理界面，支持实时预览

### 已知限制
- 消耗克数并非实时计算，在PrintEnded/Failed后进行结算生成
- 当tray_now=255时（表示无有效托盘/虚拟托盘），可能无法可靠归因到具体耗材卷
- AMS的remain字段可能为-1或异常值，表示数据不可信或不可用
- 多色/换料分摊功能尚未实现，当前不支持按托盘分摊消耗
- 3MF/GCode元数据兜底策略尚未实现，当remain不可用时无备选方案

## [0.0.1] - 2025-12-20

### 新增
这是3D耗材管理系统的首个发布版本，专为拓竹打印机设计，通过局域网MQTT连接实现实时监控与耗材管理。

#### 打印机管理与实时监控
- 打印机接入管理：支持添加/删除打印机，保存IP/序列号/LAN访问码
- 实时状态监控：自动获取并显示打印机在线状态、打印进度、当前任务
- MQTT数据采集：通过局域网直连打印机，订阅设备报告并实时解析
- 托盘信息展示：显示当前使用托盘及所有AMS托盘状态（颜色、材质、剩余量）

#### 事件采集与处理
- MQTT连接管理：支持用户名`bblp`，密码为LAN Access Code，TLS 8883端口连接
- 原始事件存储：保存所有原始MQTT payload用于排错
- 事件标准化：从原始事件中提取关键字段并存储为标准化格式
- AMS托盘解析兼容：支持从不同固件路径抽取托盘信息

#### 打印作业管理
- PrintJob自动生成/更新：由后端事件处理器根据MQTT事件生成
- 作业去重策略：优先使用task_id/subtask_id，回退到时间+文件名组合
- 状态智能修正：当gcode_state=FINISH/IDLE时不会错误显示为running
- 打印进度跟踪：实时显示打印进度百分比和预计剩余时间

#### 耗材卷管理与托盘绑定
- 耗材卷信息录入：记录材质、颜色、初始重量、价格、供应商等详细信息
- 托盘绑定管理：支持将耗材卷绑定到打印机特定托盘，可随时解绑
- 库存状态跟踪：自动维护耗材卷状态（使用中、用完、报废等）
- 库存调整记录：支持手动盘点调整，保持库存数据准确性

#### 消耗记录与成本统计
- 自动消耗计算：打印结束时自动记录消耗，基于AMS剩余量差值计算
- 成本自动核算：根据耗材价格自动计算单次打印成本
- 消耗记录追溯：每条消耗记录关联具体打印任务和耗材卷
- 库存剩余重算：实时更新耗材卷的剩余克重估算值

#### 用户界面
- 响应式Web界面：基于Next.js构建的现代化用户界面
- 实时数据展示：使用SSE技术实现打印机状态的实时更新
- 多页面导航：包括打印机、作业、耗材卷、设置等多个功能页面
- 直观的数据可视化：通过图表和列表展示关键业务数据

### 已知限制
- 消耗克数并非实时计算，在PrintEnded/Failed后进行结算生成
- 当tray_now=255时（表示无有效托盘/虚拟托盘），可能无法可靠归因到具体耗材卷
- AMS的remain字段可能为-1或异常值，表示数据不可信或不可用
- 多色/换料分摊功能尚未实现，当前不支持按托盘分摊消耗
- 3MF/GCode元数据兜底策略尚未实现，当remain不可用时无备选方案


