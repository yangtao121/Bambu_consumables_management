## 部署方式（推荐）

本指南用于 **单机 Docker Compose** 部署，并使用 **预编译 ARM64 镜像**（不在部署机上 build），同时保证：

- 数据库数据持久化（升级/重启不丢）
- 日志持久化（落盘到 Docker 卷）
- 后端启动时自动执行数据库迁移（Alembic）

## 镜像与仓库

- 私有仓库：`192.168.5.54:5000`
- 命名空间：`bambu-consumables`
- 镜像（ARM64，均带 `-arm`）：
  - `192.168.5.54:5000/bambu-consumables/api-arm:{tag}`
  - `192.168.5.54:5000/bambu-consumables/collector-arm:{tag}`
  - `192.168.5.54:5000/bambu-consumables/frontend-arm:{tag}`
- tag 策略：语义化版本 + `latest`（例如 `v1.0.0` 与 `latest`）

构建与推送方法见：`docs/镜像构建与推送-arm64.md`。

## 目录准备（建议）

在部署机上创建一个专用目录，例如：

```bash
mkdir -p /opt/bambu-consumables
cd /opt/bambu-consumables
```

将以下两个文件拷贝到该目录：

- `docker-compose.prod.yml`
- `env.example`（拷贝为 `.env` 并修改）

## 配置 .env

示例（基于仓库中的 `env.example`，并补充生产 compose 用到的变量）：

```bash
# 镜像版本（建议固定到 vX.Y.Z，上线更可控）
IMAGE_TAG=v1.0.0

# 对外端口
API_PORT=8000
FRONTEND_PORT=3000

# Postgres
POSTGRES_DB=consumables
POSTGRES_USER=consumables
POSTGRES_PASSWORD=consumables

# Backend
APP_ENV=prod
APP_SECRET_KEY=change-me-please
DATABASE_URL=postgresql+asyncpg://consumables:consumables@db:5432/consumables
ALLOW_INSECURE_MQTT_TLS=true

# Frontend（浏览器访问 API 的地址；通常应填写部署机 IP/域名）
NEXT_PUBLIC_API_BASE_URL=http://<你的服务器IP>:8000
```

## 首次启动（拉镜像 + 启动）

登录私有仓库：

```bash
docker login 192.168.5.54:5000
```

拉取镜像并启动：

```bash
docker compose -f docker-compose.prod.yml pull
docker compose -f docker-compose.prod.yml up -d
```

查看状态：

```bash
docker compose -f docker-compose.prod.yml ps
```

## 验证

- 后端健康检查：`http://<你的服务器IP>:${API_PORT}/health`
- 后端接口文档：`http://<你的服务器IP>:${API_PORT}/docs`
- 前端页面：`http://<你的服务器IP>:${FRONTEND_PORT}`

也可以在部署机上直接验证：

```bash
curl -fsS "http://127.0.0.1:${API_PORT}/health"
```

## 数据与日志持久化说明

本项目生产 compose 使用 2 个命名卷：

- `db_data`：PostgreSQL 数据目录（**核心数据持久化**）
- `logs_data`：后端/采集器日志目录（`/logs`，**日志持久化**）

查看卷：

```bash
docker volume ls | grep -E 'db_data|logs_data'
```

## 常用运维命令

```bash
# 看日志
docker compose -f docker-compose.prod.yml logs -f --tail=200 api
docker compose -f docker-compose.prod.yml logs -f --tail=200 collector

# 重启某个服务
docker compose -f docker-compose.prod.yml restart api

# 停机（保留数据卷）
docker compose -f docker-compose.prod.yml down
```

升级/回滚：见 `docs/升级与回滚.md`  
备份/恢复：见 `docs/备份与恢复.md`

