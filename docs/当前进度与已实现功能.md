# 当前进度与已实现功能

本文记录“现在代码里已经有哪些功能、已经跑通到哪里、还有哪些缺口”，用于开发/验收对齐。  
（随代码演进更新，不讨论长期架构规划请看 `docs/实现路径.md`。）

---

## 1) 当前整体链路状态（已跑通）

### 数据流
- `collector`（采集器）：
  - 局域网直连拓竹打印机 MQTT（TLS 8883）
  - 订阅 `device/<serial>/report`
  - 保存 `raw_events`（原始 payload）与 `normalized_events`（抽取后的标准化字段）
  - 同步更新 `printers.status` / `printers.last_seen`
- `backend`（API + 事件处理）：
  - 轮询 `normalized_events`，生成/更新 `print_jobs`
  - 打印结束/失败时尝试生成 `consumption_records` 并重算 `spools.remaining_grams_est`
- `frontend`（Next.js UI）：
  - 打印机列表页支持实时展示 **在线状态 + 正在打印状态/进度/任务/托盘/上报时间**

---

## 2) 已实现功能清单

### 2.1 打印机（Printers）
- **新增/删除打印机**：保存 IP/Serial/LAN Code（LAN Code 加密存储）
- **在线状态**：collector 会更新 `status=online`，并刷新 `last_seen`
- **实时打印状态展示（前端）**：
  - `gcode_state`（RUNNING/FINISH/IDLE/FAILED…）
  - `progress`（百分比）
  - `task_id/subtask_name/gcode_file`（任务标识与名称）
  - `tray_now` + `ams_trays[].remain`（当前托盘与 remain%）
  - `occurred_at`（最新上报时间）

### 2.2 事件采集（Collector）
- **MQTT 连接**：用户名 `bblp`，密码为 LAN Access Code，TLS 8883
- **写入原始事件**：`raw_events` 持续增长（每次上报一条）
- **标准化事件**：`normalized_events` 抽取关键字段（见第 4 节）
- **AMS 托盘解析兼容**：支持从 `print.ams.ams[*].tray`（常见固件路径）抽取托盘信息

### 2.3 作业（Jobs）
- **PrintJob 生成/更新**：由后端事件处理器生成
- **job_key 去重策略**：
  - 优先使用 `task_id/subtask_id`（更稳定）
  - 回退到 `gcode_start_time + gcode_file` 或 `occurred_at + gcode_file`
- **状态修正**：当 `gcode_state=FINISH/IDLE` 时不会错误显示为 running

### 2.4 耗材卷（Spools）与托盘绑定（Tray Mappings）
- **Spool CRUD**：支持录入初始克重/价格/材质/颜色等
- **TrayMapping 绑定**：支持 `printer + tray_id -> spool_id`，并支持解绑历史（`unbound_at`）

### 2.5 扣料与剩余量（Consumption）
- **扣料记录表**：`consumption_records`
- **扣料触发**：打印结束/失败时尝试结算
- **当前扣料策略**：
  - 使用 AMS `remain` 差值：`start_remain - end_remain`
  - 结束事件缺少 remain 时：回溯最近事件寻找一条带 remain 的数据
- **库存剩余重算**：`spools.remaining_grams_est = initial + adjustments - sum(consumption)`

---

## 3) 当前缺口 / 已知限制（重要）

### 3.1 “消耗克数”并非实时
- 目前 UI 实时显示的是 **remain(%)** 与打印进度；**克数扣料**在 PrintEnded/Failed 后结算生成。

### 3.2 tray_now=255 的含义
- 多数固件中 `tray_now=255` 表示“无有效托盘/虚拟托盘”，此时无法可靠归因到具体 spool，需要：
  - 等后续事件出现真实 tray_now
  - 或增加“按任务元数据/切片估算”作为 fallback（尚未实现）

### 3.3 remain 可能为 -1 / 不更新
- 已观察到 `remain=-3/-1` 等异常值，表示不可信或不可用；需要兜底策略（尚未实现）。

### 3.4 多色/换料分摊
- 当前没有生成 `TraySwitched` 分段，也没有按托盘分摊消耗（增强项）。

---

## 4) 当前标准化字段（normalized_events.data_json）

collector 目前会写入（示例）：
- `gcode_state`: RUNNING/FINISH/IDLE/FAILED…
- `progress`: 0-100
- `tray_now`: int（会把字符串数字转为 int）
- `ams_trays`: list
  - `id`: int
  - `type`: tray_type/type
  - `color`: tray_color/color
  - `remain`: remain（固件可能是百分比；也可能 -1/-3）
  - `tag_uid/tray_uuid/tray_id_name`：用于未来自动绑定/调试
- `task_id/subtask_id/subtask_name`
- `gcode_file`
- `mc_remaining_time`

---

## 5) 关键接口（便于联调/排障）

### Backend API
- `GET /printers`
- `POST /printers`
- `GET /printers/{printer_id}/latest-report`
- `GET /realtime/printers`（SSE：打印机在线状态列表）
- `GET /realtime/printers/{printer_id}`（SSE：单台打印机最新事件）
- `GET /spools`、`POST /spools`
- `POST /tray-mappings`（绑定 tray->spool）
- `GET /jobs`

---

## 6) 进度（里程碑）

### 已完成
- 打印机 LAN MQTT 连接与事件入库（raw + normalized）
- 后端事件处理：生成 job、结束结算扣料、重算剩余
- printers UI：显示在线 + 打印状态/进度/任务/托盘 remain/上报时间

### 进行中（建议下一步）
- 基于真实打印任务完成一次端到端扣料（非模拟事件）：验证 `PrintStarted/PrintEnded` 生命周期与 `tray_now` 归因
- UI：Spools 页增加“绑定到托盘”的快捷入口；Jobs 页展示本次消耗记录

### 未开始（增强项）
- 3MF/GCode 元数据兜底策略（当 remain 不可用时）
- 多色/换料分段与按托盘分摊消耗
- 报表（按月/按材质/按打印机）


